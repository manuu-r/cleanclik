# Implementation Plan

- [x] 1. Implement Complete Camera Resource Management System
  - **Create Core Data Models and Enums**: Create `CameraMode` enum with `none`, `qrScanning`, and `mlDetection` values; create `CameraStatus` enum with `uninitialized`, `initializing`, `ready`, `switching`, `error`, and `disposed` values; create `CameraState` model class with mode, status, error message, permission status, and timestamp fields; create `CameraConfiguration` model with static factory methods for QR and ML detection configurations
  - **Implement Singleton Camera Resource Manager**: Create `CameraResourceManager` singleton class with private constructor and factory method; add mutex lock field for thread-safe camera operations using `synchronized` package; implement `_activeController` field to track current camera controller instance; add `_currentMode` field to track active camera mode; create broadcast stream controller for camera state notifications
  - **Add Camera Request and Release Methods**: Create `requestCamera(CameraMode mode)` method with mutex protection; implement `releaseCamera()` method with proper resource disposal; add `_switchToMode(CameraMode mode)` private method for mode transitions; implement `_disposeCurrentCamera()` method with null safety checks; add `_initializeCameraForMode(CameraMode mode)` method with configuration-specific initialization
  - **Implement State Synchronization and Notifications**: Implement `_notifyStateChange()` method to broadcast state updates; add getter methods for `currentMode`, `isInitialized`, and `stateStream`; create `_buildCameraState()` method to construct current state object; add error state handling in state notifications; implement state validation to ensure consistency
  - **Create Riverpod Camera Provider**: Create `CameraNotifier` class extending `_$CameraNotifier` with Riverpod code generation; implement `build()` method to initialize camera manager and listen to state stream; add `switchToQRMode()` method with error handling and state updates; add `switchToMLMode()` method with error handling and state updates; implement `dispose()` method for proper cleanup
  - **Add Error Handling and Retry Mechanisms**: Add exponential backoff retry logic in `_initializeCameraForMode()` method; create `CameraException` custom exception classes for different error types; implement timeout handling for camera initialization with 10-second limit; add permission checking and error handling in camera request flow; create error recovery methods for common failure scenarios
  - **Implement Lifecycle and Performance Management**: Implement `pauseCamera()` and `resumeCamera()` methods for app lifecycle handling; add idle camera detection with 30-second timeout for resource optimization; create `_optimizeForLowMemory()` method to reduce camera buffer usage; implement camera preview pausing when not visible to conserve battery; add device orientation change handling without losing camera state
  - **Integrate QR Scanner with Camera Manager**: Modify `QRScannerWidget` to use `CameraResourceManager` instead of direct camera controller; update `_initializeCamera()` method to request camera through resource manager; remove direct camera disposal from widget dispose method; add camera state listening to handle mode switches and errors; implement error UI for camera initialization failures
  - **Integrate ML Detection with Camera Manager**: Modify `MLDetectionWidget` to use `CameraResourceManager` for camera access; update camera initialization to request ML detection mode specifically; ensure ML Kit object detector initialization happens after camera is ready; add proper cleanup for both camera and ML detector resources; implement error handling for both camera and ML Kit initialization failures
  - **Add Concurrent Access Protection**: Implement request queue system for handling multiple simultaneous camera requests; add priority system where user-initiated actions take precedence over background operations; create timeout handling for queued requests to prevent indefinite waiting; implement request cancellation for disposed widgets; add logging for camera request queue operations for debugging
  - **Optimize Camera Mode Transitions**: Add camera controller reuse logic when switching between compatible modes; implement preview stream pausing during mode switches to prevent flickering; create smooth transition animations for mode switching UI; add preemptive camera warming for anticipated mode switches; optimize camera configuration changes to minimize reinitialization
  - **Implement Error Recovery and Fallbacks**: Implement manual QR code entry fallback when camera fails in QR mode; add photo upload option for ML detection when live camera is unavailable; create clear error messages with actionable recovery steps for users; implement automatic permission request flow with user guidance; add camera hardware failure detection with graceful feature disabling
  - **Create Comprehensive Test Suite**: Write unit tests for all data models, singleton pattern, camera request/release flow, state synchronization, provider state management, error handling, and lifecycle management; write widget tests for QR scanner and ML detection integration; write integration tests for complete QR to ML mode switching flow, performance verification, stress testing for rapid mode switching, memory leak detection, device lifecycle simulation, and error recovery flows
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.3, 5.4, 5.5_